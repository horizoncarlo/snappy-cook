<!DOCTYPE html>
<html lang="en" class="sl-theme-dark">
<head>
  <meta charset="utf-8" />
  <title>Snappy Cook</title>
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üç≤</text></svg>" />
  
  <!-- Bring in the best font on earth -->
  <!-- TODO <link href="https://fonts.cdnfonts.com/css/caslon-antique" rel="stylesheet"/> -->
  
  <!-- Shoelace components -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace/cdn/themes/dark.min.css"/>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace/cdn/shoelace-autoloader.min.js"></script>
  <link rel="stylesheet" type="text/css" href="./css/shoelace-override.css" />
  
  <link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.8/dist/trix.css">
  <script type="text/javascript" src="https://unpkg.com/trix@2.0.8/dist/trix.umd.min.js"></script>
  
  <!-- Bring in Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs/dist/cdn.min.js"></script>
  
  <link rel="stylesheet" type="text/css" href="./css/main.css" />
</head>
<body x-data="state"
      style="display: none;" x-show="bodyReady" x-transition.opacity x-transition.duration.750ms x-init="Alpine.nextTick(() => { bodyReady = true })">
  
  <sl-split-panel vertical="true" snap="50%"
                  style="height: 100%; --divider-width: 10px; --min: 200px; --max: calc(100% - 200px);">
    <sl-icon slot="divider" name="grip-horizontal" title="Click and drag to readjust page layout"></sl-icon>
    <div slot="start" class="split-panel">
      <table class="recipe-table" cellspacing="0">
        <thead>
          <tr>
            <th @click="getAllRecipes('name')">Name <span x-text="'(' + recipes?.length + ')' "></span></th>
            <th @click="getAllRecipes('tags')">
              <sl-input x-model="searchIn" class="search-input"
                        :placeholder="'Search' + (isMobileSize() ? '' : ' Name and Tags') + '...'"
                        clearable="true" autocorrect="on"></sl-input>
            </th>
            <template x-if="!isMobileSize()">
              <th @click="getAllRecipes('notes')">Recipe</th>
            </template>
            <template x-if="!isMobileSize()">
              <th @click="getAllRecipes('changedDate')">Updated</th>
            </template>
            <th width="100px">
              <sl-button @click="resetRecipeIn($refs.htmlEditor.editor); $refs.manageRecipe.show();">
                <sl-icon slot="prefix" name="plus-circle"></sl-icon> New
              </sl-button>
            </th>
          </tr>
        </thead>
        <tbody>
          <template x-for="recipe in recipes" :key="recipe.id">
            <tr x-show="matchesSearch(recipe, searchIn)">
              <td x-text="recipe.name"></td>
              <td x-text="recipe.tags ? recipe.tags.join(', ') : ''" class="tag-col"></td>
              <template x-if="!isMobileSize()">
                <td>
                  <div class="notes-wrap" x-html="recipe.notes"></div>
                </td>
              </template>
              <template x-if="!isMobileSize()">
                <td><sl-relative-time :date="recipe.changedDate" sync="true" format="narrow"></sl-relative-time></td>
              </template>
              <td class="center">
                <!-- TODO Touch and hold to edit on mobile -->
                <sl-icon-button @click="resetRecipeIn($refs.htmlEditor.editor, recipe); $refs.manageRecipe.show();" name="pencil-square" title="Edit Recipe"></sl-icon-button>
                &nbsp;
                <sl-icon-button @click="deleteRecipe(recipe.id)" name="trash3" title="Delete Recipe"></sl-icon-button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
    
    <div slot="end" class="split-panel">
      <div class="week-header">
        <span>Meal Plan for the Week</span>
        <!-- TTODO Randomize week on click -->
        &nbsp;
        <sl-button title="Redo entire week" class="fright">
          <sl-icon name="dice-3"></sl-icon>
          Redo
        </sl-button>
      </div>
      <template x-for="day in week" :key="day.dayNumber">
        <div class="week-day">
          <div x-text="day.dayNumber + ' ' + day.dayName" class="day-header" :class="{ 'day-current': new Date().getDay() == day.dayNumber}"></div>
          <sl-select class="day-drop">
            <!-- TTODO Fix dropdown for recipes -->
            <template x-for="(recipe, index) in recipes">
              <sl-option x-model="day.recipe" x-text="recipe.name"></sl-option>
            </template>
          </sl-select>
          
          <!-- TTODO Randomize day on click -->
          <sl-icon-button name="dice-6" title="Redo Recipe"></sl-icon-button>
          
          <div class="day-tag">
            <!-- TTODO Open a dialog for tags. Also show count in brackets properly -->
            <sl-tag pill size="large" title="Specify tags for this day"
                    @click="dayIn = JSON.parse(JSON.stringify(day)); $refs.manageTags.show()">
              <span x-text="'Tags (' + day.tags.length + ')'"></span>
            </sl-tag>
          </div>
        </div>
      </template>
    </div>
  </sl-split-panel>
  
  <sl-dialog x-ref="manageRecipe" :label="recipeIn?.id ? 'Edit a Meal' : 'Create a New Meal'" class="dialog">
    <!-- TODO Currently the Alpine.js @submit is overriding the client side validation of Shoelace, so we need to remedy -->
    <sl-input placeholder="Meal Name" clearable="true" required="true"
              autocapitalize="words" autocorrect="on"
              :autofocus="!isMobileSize()"
              x-model="recipeIn.name" class="field-margin-bottom"></sl-input>
    
    <input id="notesIn" type="hidden" name="content" :value="recipeIn.notes"></input>
    <div @trix-change="recipeIn.notes = event.target.value" class="field-margin-bottom">
      <trix-editor x-ref="htmlEditor" input="notesIn"></trix-editor>
    </div>
    
    <div class="field-margin-bottom">
      <sl-icon name="bookmarks"></sl-icon>&nbsp;Tags:
      <!-- Use this on various inputs to handle the Enter key: @keyup.enter= -->
      <sl-input placeholder="New Tag" pill autocapitalize="words" autocorrect="on"
                x-model="tagIn" class="add-tag-input">
        <sl-icon name="plus-circle" slot="suffix"
                  @click="addTag(recipeIn)"></sl-icon>
      </sl-input>
      <template x-if="isMobileSize()">
        <br/>
      </template>
      <template x-for="(tag, index) in tags" :key="tag">
        <sl-tag removable pill size="large" x-text="tag"
                @sl-remove="deleteTag(index, tag)"
                @click="selectTag(recipeIn, tag)"
                :variant="recipeIn.tags.indexOf(tag) === -1 ? 'neutral' : 'primary'"></sl-tag>
      </template>
    </div>
    
    <!-- TODO Buttons are put to the left because they are inside a form, instead of natural right formatting. Probably just drop the form concept -->
    <div slot="footer">
      <sl-button type="reset" variant="default" class="fleft"
                 @click="recipeIn.tags.length = 0">Reset</sl-button>
      <sl-button @click="persistRecipe($refs.manageRecipe)" variant="primary">
        <sl-icon slot="prefix" name="floppy"></sl-icon> Save
      </sl-button>
    </div>
  </sl-dialog>
  
  <sl-dialog x-ref="manageTags" :label="'Manage Tags for Day (' + dayIn.tags?.length + ' Tags)'" class="dialog">
    <sl-icon name="bookmarks"></sl-icon>&nbsp;Tags:
    <!-- Use this on various inputs to handle the Enter key: @keyup.enter= -->
    <sl-input placeholder="New Tag" pill autocapitalize="words" autocorrect="on"
              x-model="tagIn" class="add-tag-input">
      <sl-icon name="plus-circle" slot="suffix"
               @click="addTag()"></sl-icon>
    </sl-input>
    <template x-if="isMobileSize()">
      <br/>
    </template>
    <template x-for="(tag, index) in tags" :key="tag">
      <sl-tag removable pill size="large" x-text="tag"
              @sl-remove="deleteTag(index, tag)"
              @click="selectTag(dayIn, tag)"
              :variant="dayIn.tags?.indexOf(tag) === -1 ? 'neutral' : 'primary'"></sl-tag>
    </template>
    
    <div slot="footer">
      <!-- TODO Save days properly with tags -->
      <sl-button variant="primary">
        <sl-icon slot="prefix" name="floppy"></sl-icon> Save
      </sl-button>
    </div>
  </sl-dialog>
  
  <!-- Used to kludge in the import for our imperative notify-->
  <sl-alert></sl-alert>
  
  <script src="./js/util.js"></script>
  <script src="./js/api.js"></script>
  <script src="./js/chef.js"></script>
</body>
</html>